<?php# MetInfo Enterprise Content Management System # Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. defined('IN_MET') or exit('No permission');load::mod_class('pay/web/pay');class app extends pay {    public function __construct() {        global $_M;        parent::__construct();    }        /**     * @param Int         paytype        支付类型，1|微信扫码支付，2|财付通支付，3|支付宝支付，4|银联支付，5|PayPal支付，6|微信H5支付     * @param String(128) body           商品描述（商品或支付单简要描述）     * @param String(256) subject        商品名称（商品的标题/交易标题/订单标题/订单关键字等，该参数最长为128个汉字）     * @param String(32)  out_trade_no   商户订单号（商户支付的订单号由商户自定义生成，长度不大于32位、可包含字母）     * @param String(127) attach         附加数据（在查询API和支付通知中原样返回，该字段主要用于商户携带订单的自定义数据）     * @param String(32)  goods_tag      商品标记（商品标记，代金券或立减优惠功能的参数）     * @param String(32)  product_id     商品ID（trade_type=NATIVE，此参数必传。此id为二维码中包含的商品ID，商户自行定义）     * @param Int         total_fee      总金额（订单总金额，原始单位为分，只能为整数。可后台处理为“元”为单位）     * @param Int(11)     no             调用接口的应用编号（存在于applist）     *      * 返回参数说明：     * ①微信扫码支付     返回微信访问地址（weixin://*****）【JSON格式'code_url'】，需要通过qrcode.php转码     * ②财付通支付       空返回（开发中）     * ③支付宝支付       无数据返回，直接跳转支付宝网关     * ④银联支付         无数据返回，直接跳转银联支付网关     * ⑤PayPal          空返回（开发中）     * ⑥微信客户端支付   以JSON形式返回微信客户端（H5支付）支付页面JS需要的两个参数（'Parameters','Address'），具体使用参考templates/met/jsapi.php文件     */    public function dointerface() {        global $_M;        //获取订单参数		$date = load::mod_class('pay/web/include/class/interface_pay', 'new')->data_decode($_M['form']['strcode']);		if(!$date){			echo json_encode(array('error'=>'time_out'));die;		}		$date['pay_type'] = $_M['form']['paytype'] ? : (empty($_GET["code"]) ? '' : '6');		if($date['pay_type'] == 5)        {            $date['return_url'] = "{$_M['url']['site']}pay/dopay.php?a=dopay&paytype=5";        }        if($this->GetPayOpen() && $date['out_trade_no']) {           if($result = $this->OrderProcessing($date)) {                echo $result;           }else{                echo json_encode(array('error'=>'Order creation failed'));die;           }        } else {            echo json_encode(array('error'=>'invalid'));die;        }    }     /**     * 订单处理 pay_order     * @DateTime 2017-03-16     * @param   array $date['out_trade_no'] 订单号     * @param  根据订单号查询，如果没有此订单-创建-启动支付 | 如果有-订单未支付-启动支付     * @param  调用的是pay.class.php的CreateOrder方法     */    public function OrderProcessing($date){        $Order = $this->GetOeder($date['out_trade_no']);        if(!$Order) {            if($this->CreateOrder($date)) {                return $this->PaymentProcessing($date);            } else {                return FALSE;            }        } else {            if(!$Order['status']) {                return $this->PaymentProcessing($date);            } else {                return FALSE;                                                        }        }    }    /**     * 支付处理     */    public function PaymentProcessing($date) {        $this->UpadteOrderPaymentType($date['pay_type'], $date['out_trade_no']);//更新订单支付类型        switch ($date['pay_type']) {            case 1://微信扫码支付                return $this->Payment_wxpay($date);            case 2://财付通支付tenpay                $this->Payment_tenpay($date);                break;            case 3://支付宝支付                $this->Payment_alipay($date);                break;            case 4://网银支付                $this->Payment_unionpay($date);                break;             case 5://PayPal支付                $this->Payment_paypal($date);                break;            case 6://微信H5-JsApiPay支付                return $this->Payment_wxpay_H5($date);            case 7://京东网银                return $this->Payment_chinabank($date);                default:                break;        }    }    public function Payment_wxpay($date) {		global $_M;        $wxpay             = load::mod_class('pay/web/wxpay.class.php', 'new');     //加载微信支付处理类        $array['code_url'] = "{$_M['url']['site']}app/system/pay/web/wxpay/qrcode.php?data=".$wxpay->wxpay($date);                              //调用微信支付接口        return json_encode($array);                                             //返回二维码链接 json 形式返回    }    public function Payment_alipay($date) {        $alipay = load::mod_class('pay/web/alipay.class.php', 'new');               //加载支付宝支付处理类        $alipay->alipay($date);                                                 //调用支付宝支付接口    }    public function Payment_tenpay($date) {        $tenpay = load::mod_class('pay/web/tenpay.class.php', 'new');                 //加载财付通处理类        $tenpay->tenpay($date);                                             //调用银联支付接口    }     public function Payment_paypal($date) {        $paypal = load::mod_class('pay/web/paypal.class.php', 'new');                  //加载paypal处理类        $paypal->paypal($date);                                             //调用银联支付接口    }      public function Payment_chinabank($date) {        $chinabank = load::mod_class('pay/web/chinabank.class.php', 'new');                  //加载京东网银处理类        $chinabank->chinabank($date);                                             //调用银联支付接口    }    public function Payment_unionpay($date) {        $unionpay = load::mod_class('pay/web/unionpay.class.php', 'new');           //加载银联支付处理类        $unionpay->unionpay($date);                                             //调用银联支付接口    }    public function Payment_wxpay_H5($date) {		global $_M;        $wxpay = load::mod_class('pay/web/wxpay.class.php', 'new');                 //加载微信支付处理类		$date['openId'] = $_M['form']['openId'];		$result         = $wxpay->JsApiPay($date);                          //调用微信H5支付接口		return json_encode($result);                                        //返回json数据 'Parameters','Address'				/*        if($_GET["code"]){            //session_start();                                                    //获取session中存储的订单信息            //$date           = $_SESSION["temp"];            $date['openId'] = $wxpay->GetOpen_ID();            $result         = $wxpay->JsApiPay($date);                          //调用微信H5支付接口            return json_encode($result);                                        //返回json数据 'Parameters','Address'        }else{            //session_start();                                                    //session 存储订单信息，备用            //$_SESSION["temp"] = $date;            $wxpay->GetOpen_ID();        }		*/    }}# This program is an open source system, commercial use, please consciously to purchase commercial license.# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.?>