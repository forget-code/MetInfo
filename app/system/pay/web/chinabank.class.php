<?php# MetInfo Enterprise Content Management System # Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. defined('IN_MET') or exit('No permission');ini_set('date.timezone','Asia/Shanghai');load::mod_class('pay/web/pay');class chinabank extends pay {    public $jdpay_config;    public function __construct() {        global $_M;        parent::__construct();        $jd_config = jsondecode($_M['config']['jdpay_config']);         $this->jdpay_config['jd_mid']          = $jd_config['jd_mid'];         $this->jdpay_config['jd_key']          = $jd_config['jd_key'];         $this->jdpay_config['jd_payment_type'] = $jd_config['jd_payment_type'];         $this->jdpay_config['banklist_cash']   = $jd_config['banklist_cash'];         $this->jdpay_config['banklist_credit'] = $jd_config['banklist_credit'];    }        /**     * 订单参数提交     */    public function chinabank($date) {        global $_M;        $v_mid      = $this->jdpay_config['jd_mid'];                            // 商户编号        $key        = $this->jdpay_config['jd_key'];                            // 商户密钥        $remark2    = "[url:={$_M['url']['pay_notify']}]";                      // 异步通知地址        $v_url      = $_M['url']['pay_return'];                                 // 同步通知地址                $v_oid          = $date['out_trade_no'];                                // 订单号        $v_amount       = $date['total_fee'];                                   // 订单金额，单位|元        $v_moneytype    = "CNY";                                                // 币种        //md5函数加密并转化成大写字母 —— md5加密拼凑串,注意顺序不能变        $v_md5info = strtoupper(md5($v_amount.$v_moneytype.$v_oid.$v_mid.$v_url.$key));        $remark1   = $date['out_trade_no'];					// 备注字段1 支付完成后，随支付反馈信息一同传给信息接收页        $pmode_id  = $date['bank'];;                                             // 代表选择的银行        /*         * 以下参数只是用来记录客户信息，可以不用，不影响支付         */	$v_rcvname   = $date['v_rcvname'];                                      // 收货人	$v_rcvaddr   = $date['v_rcvaddr'];                                      // 收货地址	$v_rcvtel    = $date['v_rcvtel'];                                       // 收货人电话	$v_rcvpost   = $date['v_rcvpost'];                                      // 收货人邮编	$v_rcvemail  = $date['v_rcvemail'];                                     // 收货人邮件	$v_rcvmobile = $date['v_rcvmobile'];                                    // 收货人手机号	$v_ordername   = $date['v_ordername'];                                  // 订货人姓名	$v_orderaddr   = $date['v_orderaddr'];                                  // 订货人地址	$v_ordertel    = $date['v_ordertel'];                                   // 订货人电话	$v_orderpost   = $date['v_orderpost'];                                  // 订货人邮编	$v_orderemail  = $date['v_orderemail'];                                 // 订货人邮件	$v_ordermobile = $date['v_ordermobile'];                                // 订货人手机号                 $url = 'https://tmapi.jdpay.com/PayGate?';                              // API请求地址        $fields = array(            'v_mid'         => $v_mid,                                          // 商户编号            'v_oid'         => $v_oid,                                          // 订单编号            'v_amount'      => $v_amount,                                       // 订单总金额            'v_moneytype'   => $v_moneytype,                                    // 币种            'v_url'         => $v_url,                                          // 同步通知地址            'v_md5info'     => $v_md5info,                                      // MD5校验码            'pmode_id'      => $pmode_id,                                       // 银行编码            'remark1'       => $remark1,                                        // 备注1 值自定义            'remark2'       => $remark2                                         // 备注2 结果通知页面        );        foreach($fields as $key=>$value) { $fields_string .= $key.'='.$value.'&'; }        $fields_string = rtrim($fields_string, '&');        $PayUrl = $url.$fields_string;        header("Location:".$PayUrl);        exit;    }            /*     * 同步通知     * PayPal同步通知即为账单支付验证确认方法     */    function doreturn($date) {        global $_M;        $key            = $this->jdpay_config['jd_key'];                        // 商户密钥                $v_oid          =trim($_POST['v_oid']);                                 // 商户发送的v_oid定单编号           $v_pmode        =trim($_POST['v_pmode']);                               // 支付方式（字符串）           $v_pstatus      =trim($_POST['v_pstatus']);                             // 支付状态 ：20（支付成功）；30（支付失败）        $v_pstring      =trim($_POST['v_pstring']);                             // 支付结果信息 ： 支付完成（当v_pstatus=20时）；失败原因（当v_pstatus=30时,字符串）；         $v_amount       =trim($_POST['v_amount']);                              // 订单实际支付金额        $v_moneytype    =trim($_POST['v_moneytype']);                           // 订单实际支付币种            $remark1        =trim($_POST['remark1' ]);                              // 备注字段1        $remark2        =trim($_POST['remark2' ]);                              // 备注字段2        $v_md5str       =trim($_POST['v_md5str' ]);                             // 拼凑后的MD5校验值                 /**         * 重新计算md5的值         */        $md5string=strtoupper(md5($v_oid.$v_pstatus.$v_amount.$v_moneytype.$key));                if($v_pstatus ==="20" && $v_md5str==$md5string)        {            return TRUE;        }        else        {            return FALSE;        }    }        /**     * 异步通知验证     */    public function donotify() {        global $_M;        $key            = $this->jdpay_config['jd_key'];                        // 商户密钥                $v_oid          =trim($_POST['v_oid']);                                 // 商户发送的v_oid定单编号           $v_pmode        =trim($_POST['v_pmode']);                               // 支付方式（字符串）           $v_pstatus      =trim($_POST['v_pstatus']);                             // 支付状态 ：20（支付成功）；30（支付失败）        $v_pstring      =trim($_POST['v_pstring']);                             // 支付结果信息 ： 支付完成（当v_pstatus=20时）；失败原因（当v_pstatus=30时,字符串）；         $v_amount       =trim($_POST['v_amount']);                              // 订单实际支付金额        $v_moneytype    =trim($_POST['v_moneytype']);                           // 订单实际支付币种            $remark1        =trim($_POST['remark1' ]);                              // 备注字段1        $remark2        =trim($_POST['remark2' ]);                              // 备注字段2        $v_md5str       =trim($_POST['v_md5str' ]);                             // 拼凑后的MD5校验值                 /**         * 重新计算md5的值         */        $md5string=strtoupper(md5($v_oid.$v_pstatus.$v_amount.$v_moneytype.$key));                if($v_pstatus ==="20" && $v_md5str==$md5string)        {            return TRUE;        }        else        {            return FALSE;        }    }}# This program is an open source system, commercial use, please consciously to purchase commercial license.# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.?>